<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RTXLauncher.Avalonia.ViewModels"
        x:Class="RTXLauncher.Avalonia.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Garry's Mod RTX Launcher" Width="870" Height="600">

	<!-- Grid is now 3 rows: Top Bar, Main Content, Bottom Buttons -->
	<Grid RowDefinitions="Auto,*,Auto" Margin="10" RowSpacing="10">

		<!-- ============================================= -->
		<!--                NEW TOP BAR                    -->
		<!-- ============================================= -->
		<Border Grid.Row="0" BorderBrush="Gray" BorderThickness="0,0,0,1" Padding="0,0,0,10">
			<Grid ColumnDefinitions="200,*" ColumnSpacing="0">
				<!-- Logo Area (Width is hardcoded to match sidebar for now) -->
				<Image Grid.Column="0" Source="/Assets/gmodrtx.png" Height="64" Stretch="Uniform" VerticalAlignment="Center"/>

				<!-- Progress Area -->
				<Grid Grid.Column="1" RowDefinitions="Auto,Auto" VerticalAlignment="Center">
					<!-- The "Cool Animation" Text Block using a Carousel -->
					<Carousel Grid.Row="0"
						ItemsSource="{Binding CarouselLog}"
						SelectedIndex="{Binding CarouselIndex}"
						MinHeight="8">
						<Carousel.PageTransition>
							<PageSlide Duration="0.1" Orientation="Vertical"/>
						</Carousel.PageTransition>
						<Carousel.ItemTemplate>
							<DataTemplate>
								<TextBlock Text="{Binding}"
										VerticalAlignment="Center"
										TextWrapping="Wrap"
										TextTrimming="CharacterEllipsis"/>
							</DataTemplate>
						</Carousel.ItemTemplate>
					</Carousel>

					<!-- Progress Bar -->
					<ProgressBar Grid.Row="1" Value="{Binding ProgressValue}" Maximum="100" Margin="0,5,0,0"/>

					<!-- Expand Log Toggle Button (overlays on the right) -->
					<ToggleButton Grid.Row="0" Grid.RowSpan="1"
                                  Content="Show Log"
                                  IsChecked="{Binding IsLogVisible}"
                                  VerticalAlignment="Center" HorizontalAlignment="Right"/>
				</Grid>
			</Grid>
		</Border>

		<!-- ============================================= -->
		<!--                MAIN CONTENT                   -->
		<!-- ============================================= -->
		<Grid Grid.Row="1" ColumnDefinitions="200,*">
			<!-- Sidebar Navigation (No change here) -->
			<ListBox Grid.Column="0" Name="SidebarListBox" ItemsSource="{Binding Pages}" SelectedItem="{Binding SelectedSidebarItem}" Margin="0,0,10,0">
				<ListBox.ItemTemplate>
					<DataTemplate>
						<TextBlock Text="{Binding Header}" Margin="5"/>
					</DataTemplate>
				</ListBox.ItemTemplate>
			</ListBox>

			<!-- Content Display Area (No change here) -->
			<Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" CornerRadius="3">
				<ContentControl Content="{Binding CurrentPage}"/>
			</Border>

			<!-- ** NEW: EXPANDABLE LOG VIEWER ** -->
			<!-- This sits on top of the content area and is toggled by the button -->
			<Border Grid.Column="1"
					Background="#303030"
                    BorderBrush="Gray" BorderThickness="1" CornerRadius="3"
                    IsVisible="{Binding IsLogVisible}">
				<Grid RowDefinitions="*,Auto">
					<!-- The Log List -->
					<ListBox Grid.Row="0" ItemsSource="{Binding FullLog}" Margin="5" Background="Black" Foreground="LimeGreen" FontFamily="Consolas"/>
					<!-- Save Button -->
					<Button Grid.Row="1" Content="Save Log to File" Command="{Binding SaveLogCommand}" Margin="5"/>
				</Grid>
			</Border>
		</Grid>

		<!-- ============================================= -->
		<!--               BOTTOM BUTTONS                  -->
		<!-- ============================================= -->
		<StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10">
			<Button Content="Open Install Folder"
					Command="{Binding OpenInstallFolderCommand}"/>

			<Button Content="Launch Game"
					Command="{Binding LaunchGameCommand}"
					CommandParameter="{Binding $parent[Window]}"/>
			<!-- Pass the Window to the command -->

			<Button Content="Close"
					Command="{Binding CloseCommand}"
					CommandParameter="{Binding $parent[Window]}"/>
			<!-- Pass the Window to the command -->
		</StackPanel>
	</Grid>
</Window>