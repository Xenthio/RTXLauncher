<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RTXLauncher.Avalonia.ViewModels"
             xmlns:models="using:RTXLauncher.Core.Models"
             xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
             xmlns:converters="using:RTXLauncher.Avalonia.Converters"
             x:Class="RTXLauncher.Avalonia.Views.ModsView"
             x:DataType="vm:ModsViewModel">

	<UserControl.Resources>
		<converters:StringIsNullOrEmptyConverter x:Key="StringIsVisibleConverter"/>
	</UserControl.Resources>

	<Grid RowDefinitions="Auto,Auto,*,Auto" Margin="10" RowSpacing="10">
		<!-- Search and Filter Area -->
		<Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="10">
			<TextBox Grid.Column="0" Text="{Binding QueryOptions.SearchText, Mode=TwoWay}" Watermark="Search for mods..." KeyUp="SearchBox_KeyUp"/>
			<ComboBox Grid.Column="1"
			          ItemsSource="{Binding SortOptions}"
			          SelectedItem="{Binding SelectedSortOption}"
			          DisplayMemberBinding="{Binding Key}"
			          Width="180"/>
			<Button Grid.Column="2" Content="Apply Filters" Command="{Binding ApplyFiltersCommand}"/>
			<ProgressBar Grid.Column="3" IsIndeterminate="True" IsVisible="{Binding IsBusy}" Width="100"/>
		</Grid>

		<!-- ModDB Notice -->
		<TextBlock Grid.Row="1" Text="Mods sourced from ModDB. For more mods, visit https://www.moddb.com/games/garrys-mod-10/mods"
                   FontSize="11" Foreground="Gray" HorizontalAlignment="Center" TextWrapping="Wrap"/>

		<!-- Mod Grid Area -->
		<ScrollViewer Grid.Row="2">
			<ItemsControl ItemsSource="{Binding Mods}">
				<ItemsControl.ItemsPanel>
					<ItemsPanelTemplate>
						<WrapPanel Orientation="Horizontal" ItemWidth="200" ItemHeight="280"/>
					</ItemsPanelTemplate>
				</ItemsControl.ItemsPanel>

				<ItemsControl.ItemTemplate>
					<DataTemplate x:DataType="vm:ModItemViewModel">
						<Border BorderBrush="Gray" BorderThickness="1" CornerRadius="4" Padding="10" Margin="5">
							<!-- Using a Grid to allow for the overlay -->
							<Grid RowDefinitions="120,Auto,Auto,*,Auto">
								<!-- Row 0: Image -->
								<Image Grid.Row="0" Stretch="UniformToFill" Source="/Assets/gmodrtx.png"
									   asyncImageLoader:ImageLoader.Source="{Binding ThumbnailUrl}"/>

								<!-- ** NEW: INSTALLED OVERLAY ** -->
								<Border Grid.Row="0" Background="#80000000" IsVisible="{Binding IsInstalled}">
									<TextBlock Text="âœ” Installed" Foreground="LawnGreen" FontWeight="Bold"
											   HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Border>

								<!-- Row 1: Title -->
								<TextBlock Grid.Row="1" Text="{Binding Title}" FontWeight="Bold" TextWrapping="Wrap" Margin="0,5,0,0"/>

								<!-- Row 2: Popularity and Author -->
								<StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="5" Margin="0,5,0,0">
									<TextBlock Text="ðŸ‘" VerticalAlignment="Center" IsVisible="{Binding TotalVisits, Converter={x:Static ObjectConverters.IsNotNull}}"/>
									<TextBlock Text="{Binding TotalVisits, StringFormat='{}{0:N0}'}" FontSize="12" Foreground="Gray" VerticalAlignment="Center"/>
									<TextBlock Text="â€¢" FontSize="12" Foreground="Gray" VerticalAlignment="Center"/>
									<TextBlock Text="{Binding Author}" Foreground="Gray" FontSize="12" VerticalAlignment="Center"/>
								</StackPanel>

								<!-- Row 3: Genre and Release Date -->
								<StackPanel Grid.Row="3" VerticalAlignment="Bottom" Margin="0,5,0,0">
									<TextBlock Text="{Binding Genre}" FontSize="11"
											   IsVisible="{Binding Genre, Converter={StaticResource StringIsVisibleConverter}}"/>
									<TextBlock Text="{Binding ReleaseDate, StringFormat='Released: {0:d}'}" FontSize="11"
											   IsVisible="{Binding ReleaseDate, Converter={x:Static ObjectConverters.IsNotNull}}"/>
								</StackPanel>

								<!-- Row 4: ** NEW: DETAILS BUTTON ** -->
								<Button Grid.Row="4" Margin="0,10,0,0"
										Content="View Details"
										HorizontalAlignment="Stretch"
										Command="{Binding $parent[ItemsControl].DataContext.ViewDetailsCommand}"
										CommandParameter="{Binding}"/>
							</Grid>
						</Border>
					</DataTemplate>
				</ItemsControl.ItemTemplate>
			</ItemsControl>
		</ScrollViewer>

		<!-- Pagination Area -->
		<StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="10">
			<Button Content="â€¹ Previous" Command="{Binding PreviousPageCommand}" IsEnabled="{Binding CanGoToPreviousPage}"/>
			<TextBlock Text="{Binding QueryOptions.Page, StringFormat='Page {0}'}" VerticalAlignment="Center"/>
			<Button Content="Next â€º" Command="{Binding NextPageCommand}" IsEnabled="{Binding CanGoToNextPage}"/>
		</StackPanel>
	</Grid>
</UserControl>